#!/bin/sh
GREEN='\033[0;32m'

VERSION=0.0.22

echo "${GREEN}\n\n\n##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}########################### Start Gradle Compile - Service A #############################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}\n\n\n"

    ./gradlew :services:service-a:build -Dquarkus.package.type=uber-jar

echo "${GREEN}\n\n\n##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}########################### Docker build & push - Service A ##############################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}\n\n\n"

  docker build -t quay.io/appdev_playground/service-mesh-basic-example:service-a-$VERSION -f services/service-a/metadata/Dockerfile services/service-a --platform linux/amd64
  docker push quay.io/appdev_playground/service-mesh-basic-example:service-a-$VERSION

echo "${GREEN}\n\n\n##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}########################### OpenShift deploy - Service A #################################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}\n\n\n"

  oc apply -f services/service-a/metadata/deployment_config.yaml
  oc apply -f services/service-a/metadata/8080_service_config.yaml

echo "${GREEN}\n\n\n##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}########################### Start Gradle Compile - Service A V2 ##########################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}\n\n\n"

    ./gradlew :services:service-a-v2:build -Dquarkus.package.type=uber-jar

echo "${GREEN}\n\n\n##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}########################### Docker build & push - Service A V2 ###########################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}\n\n\n"

  docker build -t quay.io/appdev_playground/service-mesh-basic-example:service-a-v2-$VERSION -f services/service-a-v2/metadata/Dockerfile services/service-a-v2 --platform linux/amd64
  docker push quay.io/appdev_playground/service-mesh-basic-example:service-a-v2-$VERSION

echo "${GREEN}\n\n\n##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}########################### OpenShift deploy - Service A V2 ##############################${NC}"
echo "${GREEN}##########################################################################################${NC}"
echo "${GREEN}##########################################################################################${NC}\n\n\n"

  oc apply -f services/service-a-v2/metadata/deployment_config.yaml
  oc apply -f services/service-a-v2/metadata/8080_service_config.yaml

  echo "${GREEN}\n\n\n##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}########################### Start Gradle Compile - Service B #############################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}\n\n\n"

      ./gradlew :services:service-b:build -Dquarkus.package.type=uber-jar

  echo "${GREEN}\n\n\n##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}########################### Docker build & push - Service B ##############################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}\n\n\n"

    docker build -t quay.io/appdev_playground/service-mesh-basic-example:service-b-$VERSION -f services/service-b/metadata/Dockerfile services/service-b --platform linux/amd64
    docker push quay.io/appdev_playground/service-mesh-basic-example:service-b-$VERSION

  echo "${GREEN}\n\n\n##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}########################### OpenShift deploy - Service B #################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}\n\n\n"

    oc apply -f services/service-b/metadata/deployment_config.yaml
    oc apply -f services/service-b/metadata/8080_service_config.yaml

  echo "${GREEN}\n\n\n##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}########################### Start Gradle Compile - Service C #############################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}\n\n\n"

      ./gradlew :services:service-c:build -Dquarkus.package.type=uber-jar

  echo "${GREEN}\n\n\n##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}########################### Docker build & push - Service C ##############################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}\n\n\n"

    docker build -t quay.io/appdev_playground/service-mesh-basic-example:service-c-$VERSION -f services/service-c/metadata/Dockerfile services/service-c --platform linux/amd64
    docker push quay.io/appdev_playground/service-mesh-basic-example:service-c-$VERSION

  echo "${GREEN}\n\n\n##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}########################### OpenShift deploy - Service C #################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}\n\n\n"

    oc apply -f services/service-c/metadata/deployment_config.yaml
    oc apply -f services/service-c/metadata/8080_service_config.yaml

  echo "${GREEN}\n\n\n##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}########################### Configure Service Mesh #######################################${NC}"
  echo "${GREEN}##########################################################################################${NC}"
  echo "${GREEN}##########################################################################################${NC}\n\n\n"

#    oc apply -f services/service-b/metadata/sm_1_ingress_gateway.yaml
#    oc apply -f services/service-b/metadata/sm_3_virtual_service.yaml
